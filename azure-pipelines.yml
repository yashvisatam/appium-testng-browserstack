variables:
- group: Demo Credentials

pool:
  vmImage: 'ubuntu-latest'

steps:
- checkout: none

- bash: |
    # 1. Trigger the suite
    response=$(curl -u "$BROWSERSTACK_USERNAME:$BROWSERSTACK_ACCESS_KEY" \
      -X POST "https://lcnc-api.browserstack.com/api/v1/test-suites/d5115669e729d35e6ffd81392649c85b44b4577b/trigger")
    
    BUILD_ID=$(echo $response | jq -r '.build_id')
    echo "##vso[task.setvariable variable=BUILD_ID]$BUILD_ID" # Saves ID for next step
  displayName: 'Trigger Test Suite'
  env:
    BS_USER: $(BROWSERSTACK_USERNAME) # Map secret from Library
    BS_KEY: $(BROWSERSTACK_ACCESS_KEY)   # Map secret from Library

- bash: |
    # 2. Fetch the build status
    buildStatus=""
    while [[ "$buildStatus" != "passed" && "$buildStatus" != "failed" && "$buildStatus" != "error" ]]; do
      echo "Waiting for tests... (Current: ${buildStatus:-running})"
      sleep 30
      
      # Use the Reports API to check status
      response=$(curl -u "$BROWSERSTACK_USERNAME:$BROWSERSTACK_ACCESS_KEY" -s "https://lcnc-api.browserstack.com/api/v1/builds/$(BUILD_ID)/report?type=standard")
      buildStatus=$(echo $response | jq -r '.status')
    done

    if [[ "$buildStatus" == "passed" ]]; then
      echo "Success: Build Passed"
    else
      echo "Failure: Build Status is $buildStatus"
      exit 1 # Fails the Azure Pipeline
    fi
  displayName: 'Fetch Build Status'
  env:
    BS_USER: $(BROWSERSTACK_USERNAME) # Map again for this task
    BS_KEY: $(BROWSERSTACK_ACCESS_KEY)   # Map again for this task