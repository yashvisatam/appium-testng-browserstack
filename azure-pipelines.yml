trigger:
- main

variables:
- group: "Demo Credentials" # variable group name

pool:
  vmImage: 'ubuntu-latest'

steps:
- checkout: none

- script: |

    response=$(curl -u "$BS_USER:$BS_KEY" -X POST "https://lcnc-api.browserstack.com/api/v1/test-suite/$TS_ID/run")
    
    BUILD_ID=$(echo $response | jq -r '.build_id')
    
    echo "Build ID: $BUILD_ID"

  displayName: 'Trigger Test Suite'
  env:
    BS_USER: $(BROWSERSTACK_USERNAME) # Map variable from Library
    BS_KEY: $(BROWSERSTACK_ACCESS_KEY)   # Map variable from Library
    TS_ID: $(TEST_SUITE_ID)  # Map variable from Library

- script: |
    buildStatus=""
    retryInterval=30
    
    while [[ ("$buildStatus" != "passed" && "$buildStatus" != "failed") ]]; do
      echo "Waiting for tests... (Current: ${buildStatus:-running})"
      sleep $retryInterval
      
      response=$(curl -u "$BS_USER:$BS_KEY" -s "https://lcnc-api.browserstack.com/api/v1/builds/$(BUILD_ID)/status")
      
      buildStatus=$(echo $response | jq -r '.build_status')
      
    done

    if [[ "$buildStatus" == "passed" ]]; then
      echo "Build passed"
    elif [[ "$buildStatus" == "failed" ]]; then
      echo "Build failed"
      exit 1
    else
      echo "Build status unstable: $buildStatus"
      exit 1
    fi
  displayName: 'Check Build Status'
  env:
    BS_USER: $(BROWSERSTACK_USERNAME)
    BS_KEY: $(BROWSERSTACK_ACCESS_KEY)
    